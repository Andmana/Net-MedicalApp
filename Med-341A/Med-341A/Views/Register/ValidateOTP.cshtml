@using Med_341A.viewmodels
@model VMResponse;

<div class="card">
    <div class="card-body">

        <h2 class="mt-3 text-center">Verifikasi Email</h2>
        <p class="text-center">Masukan kode OTP yang telah dikirimkan ke email anda</p>

        <form id="form_validateOTP">
            <div class="form-group">
                <input type="number" class="form-control" id="OTP" name="OTP" placeholder="input your OTP">
                <span id="OTPValidation_info" class="text-success mt-1">
                    @Model.Message
                </span>
            </div>

            <div class="form-group d-flex align-content-center text-center">
                <button type="button" id="btn_sendOTP" class="btn btn-info border-0" disabled>
                    Kirim ulang kode OTP
                    <div id="countdown" class="d-inline" style="display: none;"></div>
                </button>
            </div>

            <div class="col-lg-12 text-center mt-5">
                <button type="submit" id="btn_confirm" class="btn btn-black">
                    Konfirmasi OTP
                </button>
                <a class="btn btn-ligth fw-bold" id="btn_cancel">Batal</a>
            </div>
        </form>

    </div>
</div>

<script>
    startCountdown(180);

    function startCountdown(duration) {
        var timer = duration, minutes, seconds;
        var interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            $('#countdown').text(` (${minutes}:${seconds})`);

            timer--
            if (timer < 0) {
                clearInterval(interval);

                $('#countdown').text("");
                $("#btn_sendOTP").prop('disabled', false);
            }
        }, 1000);
    }

    $("#btn_sendOTP").click(function () {
        $("#btn_sendOTP").prop('disabled', true)
        startCountdown(180);

        $.ajax({
            url: "/Register/RetryRequestOTP",
            type: "Post",
            data: { email: "@ViewBag.Email" },
            dataType: "json",
            success: function (response) {
                var data = response.dataResponse
                $("#OTPValidation_info").text(data.message);
            }
        })
    })

    $("#btn_cancel").click(function() {
        $("#my_modal").modal("hide");
    })

    $("#form_validateOTP").validate({
        errorClass: "is-invalid text-danger",
        rules: {
            OTP: {
                required: true,
                minlength: 6,
                maxlength: 6,
            }
        },
        messages: {
            OTP: {
                required: "Masukan kode OTP yang telah dikirim",
                minlength: "Minimal 6 Digit",
                maxlength: "Maximal 6 Digit",
            }
        },
        submitHandler: function () {
            var otp = $("#OTP").val()

            $.ajax({
                url: '/Register/VerifyOTP',
                type: 'Post',
                data: { email: "@ViewBag.Email", otp },
                datatype: 'json',
                success: function (response) {
                    console.log(response)

                    var data = response.dataResponse

                    if (data.success) {

                        $("#modal_body").empty()
                        $("#modal_body").load("/Register/SetPassword")
                        $("#my_modal").modal("show")
                    } else {
                        $("#OTPValidation_info").text(data.message)
                    }
                },
                error: function (response) {
                    console.log(response)
                }
            })
        }
    })
</script>
