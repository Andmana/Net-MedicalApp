@using Med_341A.viewmodels
@model VMResponse

<div class="card">
    <div class="card-body">
        <div class="h4 mb-4">Masukkan Kode OTP yang telah dikirimkan ke email anda</div>
        <form asp-action="UbahEmail" method="post" id="form_validateOTP">
            <!-- Input OTP -->
            <div class="mb-4 row">
                <label for="OTP" class="col-sm-4 col-form-label">OTP</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="OTP" name="OTP" onkeypress="return isNumber(event)" placeholder="Masukkan kode OTP...">
                    <div id="OTPValidation_error" class="text-danger mt-1"></div>
                    <span id="OTPValidation_info" class="text-success mt-1">
                        @Model.Message
                    </span>
                </div>
                <div class="form-group d-flex justify-content-center align-items-center text-center mt-3">
                    <button type="button" id="btn_sendOTP" class="btn btn-info border-0" disabled>
                        Kirim ulang kode OTP
                        <div id="countdown" class="d-inline" style="display: none;"></div>
                    </button>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-primary" id="btn_submit">Konfirmasi OTP</button>
            </div>
        </form>
    </div>
</div>
<script>
    startCountdown(180);
    function startCountdown(duration) {
        var timer = duration, minutes, seconds;
        var interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            $('#countdown').text(` (${minutes}:${seconds})`);

            timer--
            if (timer < 0) {
                clearInterval(interval);

                $('#countdown').text("");
                $("#btn_sendOTP").prop('disabled', false);
            }
        }, 1000);
    }
    function isNumber(event) {
        var charCode = event.which ? event.which : event.keyCode;
        // Hanya mengizinkan angka (0-9)
        if (charCode < 48 || charCode > 57) {
            return false;
        }
        return true;
    }

    $("#btn_sendOTP").click(function () {
        $("#btn_sendOTP").prop('disabled', true)
        startCountdown(180);

        $.ajax({
            url: "/UserProfil/UlangRequestOTP",
            type: "Post",
            data: { email: "@ViewBag.Email" , id: "@ViewBag.Id"},
            dataType: "json",
            success: function (respon) {
                var data = respon.dataResponse
                $("#OTPValidation_info").text(data.message);
            }
        })
    })

    $("#form_validateOTP").validate({
        errorPlacement: function (error, element) {
            error.appendTo('#OTPValidation_error');
        },
        errorClass: "is-invalid text-danger",
        rules: {
            OTP: {
                required: true,
                minlength: 6,
                maxlength: 6,
            }
        },
        messages: {
            OTP: {
                required: "Masukan kode OTP yang telah dikirim",
                minlength: "Minimal 6 Digit",
                maxlength: "Maximal 6 Digit",
            }
        },
        submitHandler: function () {
            var otp = $("#OTP").val()

            $.ajax({
                url: '/UserProfil/VerifikasiOTP',
                type: 'Post',
                data: { email: "@ViewBag.Email", id: "@ViewBag.Id", otp },
                datatype: 'json',
                success: function (respon) {

                    var data = respon.dataResponse

                    if (data.success) {
                        $("#my_modal").modal("hide")
                        swal(
                            "Success",
                            data.message, {
                            icon: "success",
                            buttons: {
                                confirm: {
                                    className: "btn btn-success",
                                },
                            },
                        }
                        ).then((clickconfirm) => {
                            if (clickconfirm) {
                                window.location.href = "/Home";
                            }
                        })
                    }
                    else {
                        $("#my_modal").modal("hide")
                        swal(
                            "Failed",
                            data.message, {
                            icon: "error",
                            buttons: {
                                confirm: {
                                    className: "btn btn-danger",
                                },
                            },
                        }
                        ).then((clickconfirm) => {
                            if (clickconfirm) {
                                $("#my_modal").modal("show")
                            }
                        })
                    }
                },
                error: function (response) {
                    console.log(response)
                }
            })
        }
    })
</script>